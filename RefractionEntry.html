<!DOCTYPE html>
<html>

<head>
  <title>Refraction Entry</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="height=device-height, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
  <link rel="icon" href="https://www.iconoptical.com/wp-content/uploads/2018/02/cropped-logo-32x32.jpg">
  <link href="CSS/bootstrap.min.css" rel="stylesheet">
  <script src="JS/jquery-3.7.1.min.js"></script>
  <style>
    .f-lg {
      font-weight: 600;
      font-size: 28px;
    }

    .fixed-width {}

    /* .rx-entry,  */
    .rx-table input {
      text-align: center;
      font-weight: 600;
      font-size: 22px;
      padding-left: 0;
      padding-right: 0;
      padding-top: 10px;
      padding-bottom: 10px;
      margin-bottom: 2px;
      /* min-height: 56px; */
    }

    .rx-entry-sph {}

    .rx-entry-cyl {}

    .rx-entry-axis {}

    .rx-entry-add {}

    .rx-entry-h {}

    .rx-entry-va {}

    .rx-entry-pd {}


    .rx-table {
      /* max-width: 600px ; */
      width: 100%;
      min-width: 500px;
    }

    .numpad-container {
      /* max-width: 300px;
      min-width: 300px; */
    }

    :root {
      --aspect: 1/1;
    }

    .btn-numpad {
      aspect-ratio: var(--aspect);
      width: 100%;
    }
  </style>
  <script>
    var TouchMode = 'ontouchstart' in window

    function FillData(RefractionRecord) {
      $('#optom_name_input').html(RefractionRecord.by)

      $('[name="Purpose"]').val(RefractionRecord.Purpose)

      $('.rx-entry').each((unused, e) => {
        $(e).val(RefractionRecord[e.name])
      })

    }

    var TestData_2 = {
      optometrist: {
        name: "Yan Ka Chun",
        registration_number: "OP101026"
      },
      habbitual: {
        r: {sph: "-100", cyl: "-075", axis: "175"},
        l: {sph: "-300", cyl: "-225", axis: "013"}
      },
      full: {
        r: {sph: "-100", cyl: "-075", axis: "175", add: "250", pd: "30.5", va: "0.9"},
        l: {sph: "-300", cyl: "-225", axis: "013", pd: "31", va: "0.8-"}
      },
      adjusted: {
        purpose: "Near",
        r: {sph: "+150", cyl: "-075", axis: "175", pd: "29.5"},
        l: {sph: "-050", cyl: "-225", axis: "013", pd: "30"}
      }
    };

    var TestData_3 = {
      by: "Yan Ka Chun ( OP101026 )",
      OR_Sphere_R: "-100",
      OR_Cylinder_R: "-200",
      OR_Axis_R: "175",
      OR_PD_R: "30.5",
      OR_Prism_R: "20",
      OR_ADD_R: "250",
      OR_VA_R: "0.8+",
      OR_Sphere_L: "+075",
      OR_Cylinder_L: "-125",
      OR_Axis_L: "091",
      OR_PD_L: "31.5",
      OR_Prism_L: "20",
      OR_ADD_L: "250",
      OR_VA_L: "0.9",
      F_Sphere_R: "-125",
      F_Cylinder_R: "-225",
      F_Axis_R: "175",
      F_PD_R: "31",
      // F_Prism_R: "",
      F_ADD_R: "250",
      F_VA_R: "0.9+",
      F_Sphere_L: "+050",
      F_Cylinder_L: "-150",
      F_Axis_L: "090",
      F_PD_L: "31",
      // F_Prism_L: "",
      F_ADD_L: "250",
      F_VA_L: "0.9+",
      Purpose: "Progressive",
      // Sphere_R: "",
      // Cylinder_R: "",
      // Axis_R: "",
      // PD_R: "",
      // Prism_R: "",
      // ADD_R: "",
      // VA_R: "",
      // Sphere_L: "",
      // Cylinder_L: "",
      // Axis_L: "",
      // PD_L: "",
      // Prism_L: "",
      // ADD_L: "",
      VA_L: "1.0"
    }

    function GatherData() {
      var Refraction = {}

      $('.rx-entry').each((i, e) => {
        if (!e.value) return
        Refraction[e.name] = e.value
      })

      return Refraction
    }

    function SaveData() {
      $.ajax("https://samyankc.site/cgi/add_json", {
        contentType: 'application/json',
        type: 'POST',
        data: JSON.stringify({
          identifier_name: "refraction_id",
          custom_reference: $('#customer_phone_input').val(),
          value: GatherData()
        })
      }).then((response) => {
        $('#refraction_id_input').val(response.refraction_id);
      });
    }


    function SendTestData() {
      $.ajax("https://samyankc.site/cgi/add_json", {
        contentType: 'application/json',
        type: 'POST',
        data: JSON.stringify({
          identifier_name: "refraction_id",
          custom_reference: "98765432",
          value: TestData_3
        })
      }).then((response) => {
        $('#refraction_id_input').val(response.refraction_id);
      });
    }

    function LoadData() {
      $.ajax("https://samyankc.site/cgi/load_json", {
        type: 'GET',
        data: {
          refraction_id: $('#refraction_id_input').val(),
          custom_reference: $('#customer_phone_input').val()
        }
      }).then(FillData);
    }

    var FocusedCell;

    function UpdateNumpadDisplay() {
      $('#numpad-display-panel').val(FocusedCell.value)
    }

    function MarkFocus(Element) {
      FocusedCell = Element
      $('#CurrentFocus').html(FocusedCell.name)
      UpdateNumpadDisplay()
    }

    function Focusing(NameFragment) {
      // if (!FocusedCell) return false
      return FocusedCell?.name.includes(NameFragment)
    }

    function CheckThenInvoke(Func, Arg) {
      $('#LastNumpadKey').html(Arg ?? 'N/A')
      if (!FocusedCell || !Func) return
      Func(Arg)
      UpdateNumpadDisplay()
    }

    function AppendContent(Content) {
      FocusedCell.value += Content
    }

    function EraseBack() {
      if (FocusedCell.value === "") return
      FocusedCell.value = FocusedCell.value.slice(0, -1)
    }

    function ClearCell() {
      FocusedCell.value = ""
    }

    function SwitchToPL() {
      if (!Focusing('Sphere')) return
      FocusedCell.value = "+000"
    }

    function SwitchMinus() {
      if (Focusing('Sphere') || Focusing('Cylinder')) {
        if (FocusedCell.value === '+000') return
        FocusedCell.value = FocusedCell.value.replace('+', '-')
        if (!FocusedCell.value.startsWith('-'))
          FocusedCell.value = '-' + FocusedCell.value
      }
      else if (Focusing('VA')) {
        AppendContent('-')
      }
    }

    function SwitchPlus() {
      if (Focusing('Sphere')) {
        FocusedCell.value = FocusedCell.value.replace('-', '+')
        if (!FocusedCell.value.startsWith('+'))
          FocusedCell.value = '+' + FocusedCell.value
      } else if (Focusing('VA')) {
        AppendContent('+')
      }
    }

    window.onload = function () {
      $('#optom_name_input').val(location.hash?.substring(1))
      $('.rx-table input').attr("inputmode", "none")
      $('.rx-table input').attr("onfocus", "MarkFocus(this)")
      $('.btn-numpad').addClass('btn btn-outline-success f-lg')
      const TouchTrigger = TouchMode ? 'touchstart' : 'mousedown'
      $('.numpad-container button').on(TouchTrigger, e => {
        e.preventDefault();
        FocusedCell?.focus()
        const Func = window[e.target.getAttribute('ontouch')]
        CheckThenInvoke(Func, e.target.innerHTML)
      })


      function FocusChangeOnly(Event, Func) {

      }

      $('input[name*=Sphere_]').on('focusout', e => {
        const This = e.target
        This.value = This.value.replace(/^[\+\-]?p+l[^\d]*$/i, '+000')
        This.value = This.value.replaceAll(/[^\d\+\-]+/g, '')
      })

      $('input[name*=Cylinder_]').on('focusout', e => {
        const This = e.target
        This.value = This.value.replaceAll(/[^\d]+/g, '')
        if (This.value === "") return;
        This.value = '-' + This.value
      })

      $('input[name*=Axis_]').on('focusout', e => {
        const This = e.target
        // const Cylinder = $(`input[name=${This.name.replace('Axis', 'Cylinder')}]`)[0]
        // if (Cylinder.value === "") return This.value = ""
        This.value = This.value.replaceAll(/[^\d]+/g, '')
        switch (This.value.length) {
          case 1: This.value = '00' + This.value; break
          case 2: This.value = '0' + This.value; break
        }
      })

      $('input[name*=ADD_]').on('focusout', e => {
        const This = e.target
        This.value = This.value.replaceAll(/[^\d]+/g, '')
      })

      $('input[name*=Prism_]').on('focusout', e => {
        const This = e.target
        This.value = This.value.replaceAll(/[^\d\.]+/g, '')
      })

      $('input[name*=PD_]').on('focusout', e => {
        const This = e.target
        This.value = This.value.replaceAll(/[^\d\.]+/g, '')
      })

      // $('input[name*=_]').on('focusout', e => {
      // })

    }
  </script>
</head>

<body>
  <div style="padding-top: 10px;"></div>

  <main class="container-fluid ps-0">
    <div class="row">
      <div class="col-8">

        <div class="rx-table" autocomplete="off">
          <div class="row text-center">
            <label class="col-3 col-form-label" for="refraction_id_input">Refraction ID :</label>
            <div class="col"><input id="refraction_id_input" name="refraction_id" class="form-control"></div>

            <label class="col col-form-label" for="customer_phone_input">Customer Phone :</label>
            <div class="col"><input id="customer_phone_input" name="customer_phone" class="form-control"></div>
          </div>

          <div class="row text-center">
            <label class="col-3 col-form-label" for="optom_name_input">Optometrist :</label>
            <div class="col-6"><input id="optom_name_input" name="by" class="rx-entry form-control"></div>
            <div class="col"><button class="btn btn-success mt-1 p-2" onclick="LoadData()">Load Record</button></div>
          </div>

          <div class="ps-2">Habbitual Rx</div>
          <div id="habbitual_rx_group">
            <div class="row g-2 text-center">
              <div class="col-1"> </div>
              <div class="col">Sph</div>
              <div class="col">Cyl</div>
              <div class="col">Axis</div>
              <div class="col">ADD</div>
              <div class="col">H</div>
              <div class="col">VA</div>
              <div class="col">PD</div>
            </div>
            <div id="habbitual_r" class="row g-2">
              <div class="col-1 text-center"><label class="form-label">R</label></div>
              <div class="col"><input name="OR_Sphere_R" class="rx-entry rx-entry-sph form-control" type="text" inputmode="none" onfocus="MarkFocus(this)"></div>
              <div class="col"><input name="OR_Cylinder_R" class="rx-entry rx-entry-cyl form-control" type="text"></div>
              <div class="col"><input name="OR_Axis_R" class="rx-entry rx-entry-axis form-control" type="text"></div>
              <div class="col"><input name="OR_ADD_R" class="rx-entry rx-entry-add form-control" type="text"></div>
              <div class="col"><input name="OR_Prism_R" class="rx-entry rx-entry-h form-control" type="text"></div>
              <div class="col"><input name="OR_VA_R" class="rx-entry rx-entry-va form-control" type="text"></div>
              <div class="col"><input name="OR_PD_R" class="rx-entry rx-entry-pd form-control" type="text"></div>
            </div>
            <div id="habbitual_l" class="row g-2">
              <div class="col-1 text-center"><label class="form-label">L</label></div>
              <div class="col"><input name="OR_Sphere_L" class="rx-entry rx-entry-sph form-control" type="text"></div>
              <div class="col"><input name="OR_Cylinder_L" class="rx-entry rx-entry-cyl form-control" type="text"></div>
              <div class="col"><input name="OR_Axis_L" class="rx-entry rx-entry-axis form-control" type="text"></div>
              <div class="col"><input name="OR_ADD_L" class="rx-entry rx-entry-add form-control" type="text"></div>
              <div class="col"><input name="OR_Prism_L" class="rx-entry rx-entry-h form-control" type="text"></div>
              <div class="col"><input name="OR_VA_L" class="rx-entry rx-entry-va form-control" type="text"></div>
              <div class="col"><input name="OR_PD_L" class="rx-entry rx-entry-pd form-control" type="text"></div>
            </div>
          </div>

          <div class="ps-2">Full Rx</div>
          <div id="full_rx_group">
            <div class="row g-2 text-center">
              <div class="col-1"> </div>
              <div class="col">Sph</div>
              <div class="col">Cyl</div>
              <div class="col">Axis</div>
              <div class="col">ADD</div>
              <div class="col">H</div>
              <div class="col">VA</div>
              <div class="col">PD</div>
            </div>
            <div id="full_r" class="row g-2">
              <div class="col-1 text-center"><label class="form-label">R</label></div>
              <div class="col"><input name="F_Sphere_R" class="rx-entry rx-entry-sph form-control" type="text"></div>
              <div class="col"><input name="F_Cylinder_R" class="rx-entry rx-entry-cyl form-control" type="text"></div>
              <div class="col"><input name="F_Axis_R" class="rx-entry rx-entry-axis form-control" type="text"></div>
              <div class="col"><input name="F_ADD_R" class="rx-entry rx-entry-add form-control" type="text"></div>
              <div class="col"><input name="F_Prism_R" class="rx-entry rx-entry-h form-control" type="text"></div>
              <div class="col"><input name="F_VA_R" class="rx-entry rx-entry-va form-control" type="text"></div>
              <div class="col"><input name="F_PD_R" class="rx-entry rx-entry-pd form-control" type="text"></div>
            </div>
            <div id="full_l" class="row g-2">
              <div class="col-1 text-center"><label class="form-label">L</label></div>
              <div class="col"><input name="F_Sphere_L" class="rx-entry rx-entry-sph form-control" type="text"></div>
              <div class="col"><input name="F_Cylinder_L" class="rx-entry rx-entry-cyl form-control" type="text"></div>
              <div class="col"><input name="F_Axis_L" class="rx-entry rx-entry-axis form-control" type="text"></div>
              <div class="col"><input name="F_ADD_L" class="rx-entry rx-entry-add form-control" type="text"></div>
              <div class="col"><input name="F_Prism_L" class="rx-entry rx-entry-h form-control" type="text"></div>
              <div class="col"><input name="F_VA_L" class="rx-entry rx-entry-va form-control" type="text"></div>
              <div class="col"><input name="F_PD_L" class="rx-entry rx-entry-pd form-control" type="text"></div>
            </div>
          </div>

          <div class="ps-2">
            <span>Adjusted Rx</span>
            <span class="ms-4"> 用途: </span>
            <span>
              <select name="Purpose" class="rx-entry rx-entry-purpose">
                <option value="Distant">Distant</option>
                <option value="Near">Near</option>
                <option value="Progressive">Progressive</option>
                <option value="Record">Record</option>
              </select>
            </span>
          </div>

          <div id="adjusted_rx_group">

            <div class="row g-2 text-center">
              <div class="col-1"> </div>
              <div class="col">Sph</div>
              <div class="col">Cyl</div>
              <div class="col">Axis</div>
              <div class="col">ADD</div>
              <div class="col">H</div>
              <div class="col">VA</div>
              <div class="col">PD</div>
            </div>
            <div id="adjusted_r" class="row g-2">
              <div class="col-1 text-center"><label class="form-label">R</label></div>
              <div class="col"><input name="Sphere_R" class="rx-entry rx-entry-sph form-control" type="text"></div>
              <div class="col"><input name="Cylinder_R" class="rx-entry rx-entry-cyl form-control" type="text"></div>
              <div class="col"><input name="Axis_R" class="rx-entry rx-entry-axis form-control" type="text"></div>
              <div class="col"><input name="ADD_R" class="rx-entry rx-entry-add form-control" type="text"></div>
              <div class="col"><input name="Prism_R" class="rx-entry rx-entry-h form-control" type="text"></div>
              <div class="col"><input name="VA_R" class="rx-entry rx-entry-va form-control" type="text"></div>
              <div class="col"><input name="PD_R" class="rx-entry rx-entry-pd form-control" type="text"></div>
            </div>
            <div id="adjusted_l" class="row g-2">
              <div class="col-1 text-center"><label class="form-label">L</label></div>
              <div class="col"><input name="Sphere_L" class="rx-entry rx-entry-sph form-control" type="text"></div>
              <div class="col"><input name="Cylinder_L" class="rx-entry rx-entry-cyl form-control" type="text"></div>
              <div class="col"><input name="Axis_L" class="rx-entry rx-entry-axis form-control" type="text"></div>
              <div class="col"><input name="ADD_L" class="rx-entry rx-entry-add form-control" type="text"></div>
              <div class="col"><input name="Prism_L" class="rx-entry rx-entry-h form-control" type="text"></div>
              <div class="col"><input name="VA_L" class="rx-entry rx-entry-va form-control" type="text"></div>
              <div class="col"><input name="PD_L" class="rx-entry rx-entry-pd form-control" type="text"></div>
            </div>
          </div>
        </div>

        <div class="pb-5"></div>

        <button class="btn btn-success" onclick="SaveData()">Save</button>
        <button class="btn btn-success" onclick="SendTestData()">Send Test Data</button>
      </div>

      <div class="col-4 m-auto">

        <div id="Debug_Info_Display" class="mb-3">
          <table>
            <tr>
              <td> Element in Focus | </td>
              <td>
                <div id="CurrentFocus"></div>
              </td>
            </tr>
            <tr>
              <td> Last Numpad Key | </td>
              <td>
                <div id="LastNumpadKey"></div>
              </td>
            </tr>
          </table>
        </div>

        <div class="row row-cols-4 g-0 text-center numpad-container">

          <div class="col-6"><button class="btn-numpad" style="--aspect:2/1;" ontouch="ClearCell">Clear</button></div>
          <div class="col-6"><button class="btn-numpad" style="--aspect:2/1;" ontouch="NextCell">Next</button></div>

          <div class="col-12 pb-3"></div>

          <div class="col-10"><input class="btn-numpad f-lg" style="--aspect:10/3;" disabled type="text" id="numpad-display-panel"></div>
          <div class="col-2"><button class="btn-numpad f-lg" style="--aspect:2/3;" ontouch="EraseBack">&#129092;</button></div>

          <div class="col-4"><button class="btn-numpad f-lg" style="--aspect:3/2;" ontouch="SwitchMinus">-</button></div>
          <div class="col-4"><button class="btn-numpad f-lg" style="--aspect:3/2;" ontouch="SwitchToPL">PL</button></div>
          <div class="col-4"><button class="btn-numpad f-lg" style="--aspect:3/2;" ontouch="SwitchPlus">+</button></div>

          <div class="col"><button class="btn-numpad" ontouch="AppendContent">7</button></div>
          <div class="col"><button class="btn-numpad" ontouch="AppendContent">8</button></div>
          <div class="col"><button class="btn-numpad" ontouch="AppendContent">9</button></div>

          <div class="col"><button class="btn-numpad" ontouch="AppendContent">75</button></div>

          <div class="col"><button class="btn-numpad" ontouch="AppendContent">4</button></div>
          <div class="col"><button class="btn-numpad" ontouch="AppendContent">5</button></div>
          <div class="col"><button class="btn-numpad" ontouch="AppendContent">6</button></div>

          <div class="col"><button class="btn-numpad" ontouch="AppendContent">50</button></div>

          <div class="col"><button class="btn-numpad" ontouch="AppendContent">1</button></div>
          <div class="col"><button class="btn-numpad" ontouch="AppendContent">2</button></div>
          <div class="col"><button class="btn-numpad" ontouch="AppendContent">3</button></div>

          <div class="col"><button class="btn-numpad" ontouch="AppendContent">25</button></div>

          <div class="col-6"><button class="btn-numpad" style="--aspect:2/1;" ontouch="AppendContent">0</button></div>
          <div class="col"><button class="btn-numpad" ontouch="AppendContent">.</button></div>
          <div class="col"><button class="btn-numpad" ontouch="AppendContent">00</button></div>

        </div>
      </div>
    </div>

  </main>

</body>

</html>